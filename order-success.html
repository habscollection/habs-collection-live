<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Confirmation - Habs Collection</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/order-success.css">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Load API and Cart scripts early with defer attribute -->
    <script src="scripts/api.js" defer></script>
    <script src="scripts/cart.js" defer></script>
</head>
<body>
    <!-- Announcement Bar -->
    <div class="announcement-bar">
        <p>FREE SHIPPING ON ORDERS OVER £300</p>
    </div>

    <nav class="navbar">
        <div class="nav-left">
            <a href="products.html">EID-AL FITR COLLECTION - Limited Edition</a>
        </div>
        <div class="nav-center">
            <a href="/" class="brand-logo">HABS COLLECTION</a>
        </div>
        <div class="nav-right">
            <a href="/account.html" class="nav-icon">Account</a>
            <a href="#cart" class="nav-icon">Cart (<span class="cart-count">0</span>)</a>
        </div>

        <div class="mobile-nav-right">
            <a href="/account.html" class="nav-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </a>
            <a href="#cart" class="nav-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
                <span class="cart-count">0</span>
            </a>
        </div>

        <button class="mobile-menu-toggle" aria-label="Toggle Menu">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu-overlay"></div>
    <div class="mobile-menu">
        <button class="mobile-menu-close">&times;</button>
        <a href="products.html">EID-AL FITR COLLECTION - Limited Edition</a>
        <a href="/account.html">Account</a>
        <a href="#cart">Cart (0)</a>
    </div>

    <main class="success-page">
        <div class="success-page-container">
        <div class="success-container">
            <div class="success-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
            
            <h1>Order Confirmed</h1>
            <p class="confirmation-message">Thank you for your purchase! Your order has been successfully placed and will be processed shortly. A confirmation email has been sent to your email address.</p>
            
            <div class="next-steps">
                <h3>What's Next?</h3>
                <ul>
                    <li>You will receive an email confirmation shortly with your order details.</li>
                    <li>Your order is being processed and will be shipped within 2-3 business days.</li>
                    <li>Once your order ships, you will receive a shipping confirmation email with tracking information.</li>
                    <li>Please allow 5-7 business days for your order to arrive after shipping.</li>
                    <li>*Eid Delivery could be accommodated upon request</li>
                </ul>

                <h3>Contact Us</h3>
                <ul>
                    <li>If you have any questions or concerns, please contact us at <a href="mailto:thehabscollection@gmail.com">thehabscollection@gmail.com</a>.</li>
                    <li>We are available to assist you from 9am to 5pm Monday to Friday.</li>
                </ul>
            </div>
            
            <div class="action-buttons">
                <a href="products.html" class="btn-continue-shopping">Continue Shopping</a>
            </div>
        </div>
    </main>

    <!-- Updated Footer -->
    <footer class="site-footer">
        <div class="footer-container">
            <div class="footer-grid">
                <div class="footer-section">
                    <h4>LATEST COLLECTION</h4>
                    <ul>
                        <li><a href="#abayas">ABAYAS</a></li>
                        <li><a href="#dresses">DRESSES</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>CUSTOMER SERVICE</h4>
                    <ul>
                        <li><a href="#contact">Contact Us</a></li>
                        <li><a href="#shipping">Shipping Information</a></li>
                        <li><a href="#returns">Returns & Exchanges</a></li>
                        <li><a href="#size-guide">Size Guide</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>ABOUT</h4>
                    <ul>
                        <li><a href="#story">Our Story</a></li>
                        <li><a href="#sustainability">Sustainability</a></li>
                        <li><a href="#stores">Stores</a></li>
                    </ul>
                </div>

                <div class="footer-section newsletter">
                    <h4>NEWSLETTER</h4>
                    <p>Subscribe to receive updates, access to exclusive deals, and more.</p>
                    <form class="newsletter-form">
                        <div class="input-group">
                            <input type="email" placeholder="Enter your email address" required>
                            <button type="submit">Subscribe</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="footer-left">
                    <p>© 2024 - HABS COLLECTION</p>
                </div>
                <div class="footer-right">
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Mobile menu functionality
        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const mobileMenu = document.querySelector('.mobile-menu');
        const mobileMenuOverlay = document.querySelector('.mobile-menu-overlay');
        const mobileMenuClose = document.querySelector('.mobile-menu-close');

        function toggleMobileMenu() {
            mobileMenu.classList.toggle('active');
            mobileMenuOverlay.classList.toggle('active');
            mobileMenuToggle.classList.toggle('active');
            document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
        }

        mobileMenuToggle.addEventListener('click', toggleMobileMenu);
        mobileMenuClose.addEventListener('click', toggleMobileMenu);
        mobileMenuOverlay.addEventListener('click', toggleMobileMenu);

        // Close mobile menu when clicking on a link
        const mobileMenuLinks = mobileMenu.querySelectorAll('a');
        mobileMenuLinks.forEach(link => {
            link.addEventListener('click', toggleMobileMenu);
        });

        // Order Success Page Logic
        document.addEventListener('DOMContentLoaded', async function() {
            // Get order ID from URL parameter
            const params = new URLSearchParams(window.location.search);
            const orderId = params.get('id');
            
            if (!orderId) {
                console.error('No order ID provided, redirecting to home page');
                // Redirect to home page if no order ID is provided
                window.location.href = '/';
                return;
            }
            
            // Security check - verify this came from the payment flow
            const fromPayment = sessionStorage.getItem('payment_verified');
            if (!fromPayment) {
                // Check if we came from a legitimate payment verification
                const referrer = document.referrer;
                const isFromPaymentPage = referrer.includes('payment-success.html');
                
                if (!isFromPaymentPage) {
                    console.warn('Direct access to order success page detected without payment verification');
                    // For improved user experience, try to verify the order with the server
                    try {
                        // Check if order exists and is paid
                        const verifyResponse = await fetch(`/api/orders/verify/${orderId}`);
                        if (!verifyResponse.ok) {
                            console.error('Failed to verify order, redirecting to home page');
                            window.location.href = '/';
                            return;
                        }
                        
                        const verifyResult = await verifyResponse.json();
                        if (!verifyResult.valid) {
                            console.error('Order verification failed, redirecting to home page');
                            window.location.href = '/';
                            return;
                        }
                        
                        // If we got here, the order is valid despite not coming from payment flow
                        console.log('Order verified via server despite bypassing payment flow');
                    } catch (verifyError) {
                        // If verification fails or endpoint doesn't exist, redirect home
                        console.error('Order verification error, redirecting to home page');
                        window.location.href = '/';
                        return;
                    }
                }
            } else {
                // Clear the payment verification flag
                sessionStorage.removeItem('payment_verified');
            }
            
            try {
                // Fetch order details from API
                const response = await fetch(`/api/orders/${orderId}`);
                if (!response.ok) {
                    console.error('Failed to fetch order by MongoDB ID, trying with orderId');
                    
                    // If the order is not found by MongoDB ID, try with orderId
                    try {
                        // Use the verify endpoint which supports both types of IDs
                        const verifyResponse = await fetch(`/api/orders/verify/${orderId}`);
                        if (!verifyResponse.ok) {
                            throw new Error('Failed to verify order');
                        }
                        
                        const verifyResult = await verifyResponse.json();
                        if (!verifyResult.valid) {
                            throw new Error('Order is not valid or not paid');
                        }
                        
                        // Use the MongoDB ID from the verification response
                        const secondResponse = await fetch(`/api/orders/${verifyResult._id}`);
                        if (!secondResponse.ok) {
                            throw new Error('Failed to fetch order after verification');
                        }
                        
                        const order = await secondResponse.json();
                        updateOrderDisplay(order);
                        return;
                    } catch (secondError) {
                        console.error('Error during alternative order fetch:', secondError);
                        throw new Error('Failed to fetch order details');
                    }
                }
                
                const order = await response.json();
                updateOrderDisplay(order);
            } catch (error) {
                console.error('Error fetching order details:', error);
                // Show error state in UI
                document.getElementById('order-number').textContent = orderId;
                document.getElementById('order-date').textContent = new Date().toLocaleDateString();
                document.getElementById('shipping-address').textContent = 'Error loading address';
                document.getElementById('payment-method').textContent = 'Error loading payment method';
                document.getElementById('total-amount').textContent = 'Error loading total';
            }
            
            // Helper function to update the order display
            function updateOrderDisplay(order) {
                document.getElementById('order-number').textContent = order._id;
                document.getElementById('order-date').textContent = new Date(order.createdAt).toLocaleDateString();
                document.getElementById('shipping-address').textContent = `${order.shipping.address}, ${order.shipping.city}, ${order.shipping.postcode}, ${order.shipping.country}`;
                document.getElementById('payment-method').textContent = order.payment.method === 'card' ? 'Credit/Debit Card' : order.payment.method;
                document.getElementById('total-amount').textContent = `£${order.total.toFixed(2)}`;
                
                // Set up tracking button (placeholder functionality)
                document.getElementById('track-order-btn').addEventListener('click', function(e) {
                    e.preventDefault();
                    alert('Order tracking will be available once your order ships.');
                });
            }
        });
    </script>
</body>
</html> 